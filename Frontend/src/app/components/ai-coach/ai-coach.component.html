<div class="ai-coach-container" [class.open]="isOpen">
    <!-- Floating Button -->
    <button mat-fab color="accent" class="chat-fab" (click)="toggleChat()" *ngIf="!isOpen">
        <img src="assets/dragon-ball.png" alt="Dragon Ball" class="db-icon">
    </button>

    <!-- Chat Window -->
    <div class="chat-window" *ngIf="isOpen">
        <div class="chat-header">
            <div class="header-info">
                <img src="assets/vegeta-symbol.png" alt="Saiyan Crest" class="header-icon">
                <span>AI Coach</span>
            </div>
            <button mat-icon-button (click)="toggleChat()">
                <mat-icon>close</mat-icon>
            </button>
        </div>

        <div class="chat-messages" #scrollContainer>
            <div *ngFor="let msg of messages" class="message" [class.user]="msg.role === 'user'"
                [class.model]="msg.role === 'model'">
                <div class="message-content">
                    <!-- User messages: plain text -->
                    <span *ngIf="msg.role === 'user'">{{ msg.text }}</span>
                    <!-- AI messages: parsed markdown -->
                    <markdown *ngIf="msg.role === 'model'" [data]="msg.text"></markdown>
                </div>
                <div class="message-time">{{ msg.time | date:'shortTime' }}</div>
            </div>

            <div class="loading-indicator" *ngIf="loading">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
            </div>

            <div class="suggestions" *ngIf="messages.length === 1 && !loading">
                <div class="chip" *ngFor="let s of suggestions" (click)="selectSuggestion(s)">
                    {{ s }}
                </div>
            </div>
        </div>

        <div class="chat-input">
            <input type="text" [(ngModel)]="userInput" (keyup.enter)="sendMessage()" placeholder="Ask me anything..."
                [disabled]="loading">
            <button mat-icon-button color="primary" (click)="sendMessage()" [disabled]="!userInput.trim() || loading">
                <mat-icon>send</mat-icon>
            </button>
        </div>
    </div>
</div>